name: Build & Deploy to AKS (DEV)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy-dev:
    runs-on: ubuntu-latest

    env:
      # Cluster namespace
      K8S_NAMESPACE: ccaas
      
      # Timezone for container logs
      TIME_ZONE: Asia/Kolkata

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      # Azure login (service principal)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Login to Azure Container Registry
      - name: Login to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      # Fetch AKS kubeconfig
      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} \
            --name ${{ secrets.AKS_CLUSTER_NAME }} \
            --overwrite-existing

      # Docker auth for JIB (required for push)
      - name: Setup Docker auth
        run: |
          mkdir -p ~/.docker
          echo "{
            \"auths\": {
              \"${{ secrets.ACR_NAME }}.azurecr.io\": {
                \"username\": \"${{ secrets.ACR_USERNAME }}\",
                \"password\": \"${{ secrets.ACR_PASSWORD }}\"
              }
            }
          }" > ~/.docker/config.json

      # ðŸš€ Build & Push multi-arch image with JIB
      - name: Maven Build & Deploy (DEV)
        run: |
          mvn clean package jib:build \
            -Denv=dev \
            -DskipTests
            -Djib.to.tags=${{ github.sha }},latest
        env:
          # Registry used by pom profiles
          ACR_NAME: ${{ secrets.ACR_NAME }}

          # Base docker image
          BASE_IMAGE: ${{ secrets.BASE_IMAGE }}

          # Ingress domain for personal AKS
          INGRESS_HOST: ${{ vars.INGRESS_HOST_DEV }}

          # Secret injected into pod (already created in AKS)
          K8S_SECRET_NAME: ${{ secrets.K8S_SECRET_NAME }}

          # Namespace used by JKube
          K8S_NAMESPACE: ccaas

          # Container timezone
          TIME_ZONE: Asia/Kolkata
        
      - name: Deploy to AKS (JKube)
        run: |
          mvn k8s:resource k8s:apply \
            -Denv=dev \
            -DskipTests
        env:
          ACR_NAME: ${{ secrets.ACR_NAME }}
          BASE_IMAGE: ${{ secrets.BASE_IMAGE }}
          INGRESS_HOST: ${{ vars.INGRESS_HOST_DEV }}
          K8S_SECRET_NAME: ${{ secrets.K8S_SECRET_NAME }}
          K8S_NAMESPACE: ccaas
          TIME_ZONE: Asia/Kolkata
